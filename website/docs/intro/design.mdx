---
title: Design
description: Application architecture
sidebar_position: 1
---

## How It Works

1. The app loads your portfolio configuration (from `config.yaml` or event files)
2. Two independent scheduled jobs run in parallel:
   - **Scraping**: Fetches current stock prices from Yahoo! Finance
   - **Ingestion**: Reloads portfolio configuration (with caching)
3. The app exposes data in OpenMetrics format
4. Prometheus scrapes this data and stores it
5. Grafana reads Prometheus to display the data in a dashboard

![Diagram](/img/diagram.png)

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         SuiviBourse                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────┐     ┌─────────────────────┐          │
│   │     INGESTION       │     │      SCRAPING       │          │
│   │   (every 300s)      │     │    (every 120s)     │          │
│   │                     │     │                     │          │
│   │  • Load config or   │     │  • Fetch prices     │          │
│   │    event files      │     │    from Yahoo!      │          │
│   │  • Validate         │     │  • Update metrics   │          │
│   │  • Aggregate        │     │                     │          │
│   │  • Cache (mtime)    │     │                     │          │
│   └──────────┬──────────┘     └──────────┬──────────┘          │
│              │                           │                      │
│              └───────────┬───────────────┘                      │
│                          ▼                                      │
│              ┌─────────────────────┐                           │
│              │  Prometheus Metrics │ ◄─── :8081/metrics        │
│              └─────────────────────┘                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   Prometheus    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │     Grafana     │
                    └─────────────────┘
```

### Two Independent Schedules

The application runs two separate scheduled jobs that operate independently:

| Job | Default Interval | Purpose | Error Impact |
|-----|------------------|---------|--------------|
| **Scraping** | 120 seconds | Fetch stock prices from Yahoo! Finance | Retries with exponential backoff |
| **Ingestion** | 300 seconds | Reload portfolio configuration | Keeps previous valid config |

:::tip Why separate schedules?
- **Ingestion errors don't block scraping**: If your event files have an error, price updates continue with the last valid configuration
- **Different update frequencies**: Stock prices change constantly, but your portfolio changes rarely
- **Efficient caching**: Ingestion only reprocesses when files actually change (based on modification time)
:::

---

## Exposed Metrics

The app exposes the following Prometheus metrics on `:8081/metrics`:

### Portfolio Metrics

| Metric | Description | Labels |
|--------|-------------|--------|
| `sb_purchased_quantity` | Quantity of purchased shares | `share_name`, `share_symbol` |
| `sb_purchased_price` | Cost price of purchased shares (weighted avg) | `share_name`, `share_symbol` |
| `sb_purchased_fee` | Total transaction fees | `share_name`, `share_symbol` |
| `sb_owned_quantity` | Currently owned quantity | `share_name`, `share_symbol` |
| `sb_received_dividend` | Total received dividends | `share_name`, `share_symbol` |

### Market Data Metrics

| Metric | Description | Labels |
|--------|-------------|--------|
| `sb_share_price` | Current market price | `share_name`, `share_symbol` |
| `sb_share_info` | Share metadata (value always 1) | `share_name`, `share_symbol`, `share_currency`, `share_exchange`, `quote_type` |
| `sb_dividend_yield` | Dividend yield (%) | `share_name`, `share_symbol` |
| `sb_pe_ratio` | Price-to-Earnings ratio | `share_name`, `share_symbol` |
| `sb_market_cap` | Market capitalization | `share_name`, `share_symbol` |

:::note
Some metrics (`sb_dividend_yield`, `sb_pe_ratio`, `sb_market_cap`) may not be available for all asset types (e.g., ETFs, cryptocurrencies).
:::

---

## Configuration Modes

SuiviBourse supports two configuration modes. See the [Configuration](/docs/intro/config) page for details.

| Mode | Source | Use Case |
|------|--------|----------|
| **Manual** | `config.yaml` | Simple, static portfolio |
| **Events** | `events/*.csv`, `*.xlsx` | Transaction history, automatic aggregation |
