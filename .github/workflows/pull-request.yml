name: "Acceptance tests"

on:
  pull_request:
    branches: [master]

jobs:
  dco-check:
    name: DCO Check
    runs-on: ubuntu-latest
    steps:
      - uses: tisonkun/actions-dco@v1.1

  python-linter:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: ricardochaves/python-lint@v1.4.0
        with:
          python-root-list: "app/src/"
          use-pycodestyle: false
          use-pylint: false
          use-black: false
          use-mypy: false
          use-isort: false
          extra-flake8-options: "--ignore=E501"

  codeql:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["python"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  e2e-test:
    name: "E2E Test"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: "0"

      - uses: actions/setup-python@v4.1.0
        with:
          python-version: "3.x"

      - uses: BSFishy/pip-action@v1
        with:
          requirements: app/requirements.txt

      - uses: BSFishy/pip-action@v1
        with:
          packages: |
            requests

      - id: run_tests
        run: |
          mkdir -p ~/.config/SuiviBourse
          cat > ~/.config/SuiviBourse/config.yaml << EOL
          ---
          shares:
          - name: Apple
            symbol: AAPL
            purchase:
              quantity: 1
              fee: 2
              cost_price: 119.98
            estate:
              quantity: 2
              received_dividend: 2.85
          EOL
          python3 app/src/main.py &
          sleep 20
          python3 utils/testing.py
